<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Korean of the day</title>
<meta name="description" content="Tap to reveal today’s line." />
<meta property="og:title" content="Korean of the day" />
<meta property="og:description" content="Tap to reveal today’s line." />
<meta property="og:type" content="website" />

<style>
  html,body{height:100%;margin:0}
  body{
    background:#7d8fb3; /* pastel navy */
    display:grid; grid-template-rows:auto 1fr auto; place-items:center;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial
  }
  header{ text-align:center; padding:8px 10px 0 }
  .title{ font-weight:700; font-size:22px; color:#0f172a; margin:0 0 2px }
  .subtitle{ font-size:13px; color:#e5e7eb; margin:0 0 4px }

  :root{ --globe: min(39vmin, 320px); }

  .stage{
    width:100%; height:100%;
    display:grid; place-content:start center;
    padding-top:4.2vh; padding-inline:12px; box-sizing:border-box;
  }

  .globe-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .tap{
    font:500 13px/1 ui-sans-serif; color:#e8eefc;
    text-shadow:0 1px 2px rgba(0,0,0,.25); opacity:.95;
  }
  .globe{
    width:var(--globe); aspect-ratio:1/1; border-radius:50%;
    display:grid; place-items:center; position:relative; overflow:hidden;
    cursor:pointer; user-select:none; transition:transform .22s ease;
    box-shadow: 0 28px 60px rgba(10,16,30,.28), 0 3px 10px rgba(0,0,0,.18);
    background: radial-gradient(120% 120% at 35% 30%, #f8fafc 0%, #eef2ff 45%, #e2e8f0 100%);
  }
  .globe:active{ transform:scale(.985) }

  /* word sphere */
  #word-sphere{ position:absolute; inset:0; border-radius:50%; overflow:hidden }
  #word-sphere .ws-space{ position:absolute; inset:0; transform-style:preserve-3d; perspective:1200px }
  #word-sphere .ws-word{
    position:absolute; left:50%; top:50%;
    transform-style:preserve-3d; white-space:nowrap;
    font-weight:700; letter-spacing:.3px; color:#0f172a;
    text-shadow:0 1px 2px rgba(0,0,0,.12);
    will-change:transform, opacity, filter;
  }
  #word-sphere .ws-word.ws-accent{ color:#f59e0b; }

  /* RESULT: cover left, text+meta right */
  .fortune-card{
    max-width:980px; width:min(92vw,980px);
    margin:28px auto 18px; padding:18px;
    display:none; gap:22px; align-items:flex-start;
    background:rgba(255,255,255,.08); backdrop-filter:blur(6px);
    border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.2);
    color:#0f172a;
  }
  .fortune-card.show{ display:flex; }
  .fc-left{ flex:0 0 260px }
  .fc-left img{ width:100%; height:auto; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25) }
  .fc-right{ flex:1; min-width:0; display:flex; flex-direction:column; gap:10px }
  .fc-text{ font-size:1.25rem; line-height:1.55; font-weight:700; color:#0f172a }
  .fc-actions{ display:flex; gap:8px; }
  .btn{ font:600 13px/1 ui-sans-serif; padding:9px 12px; border-radius:10px; border:0; cursor:pointer }
  .btn.copy{ background:#111827; color:#fff }
  .btn.open{ background:#f59e0b; color:#fff; display:none }
  .fc-meta{ font-size:.95rem; color:#122; }
  .fc-title{ font-weight:700 }
  .fc-by,.fc-isbn{ opacity:.85; margin-top:2px }
  .fc-link{ display:inline-block; margin-top:8px; text-decoration:underline }

  .again{ position:fixed; left:50%; bottom:8px; transform:translateX(-50%);
          font:400 12px/1.2 ui-sans-serif; color:#e2e8f0; opacity:.95; display:none }

  @media (max-width:760px){
    .fortune-card{ flex-direction:column; }
    .fc-left{ flex:0 0 auto }
  }
</style>
</head>
<body>

<header>
  <h1 class="title">Korean of the day</h1>
  <p class="subtitle">Tap the globe to reveal today’s line.</p>
</header>

<main class="stage">
  <div class="globe-wrap">
    <button id="globe" class="globe" aria-label="Tap to reveal today’s line">
      <div id="word-sphere"><div class="ws-space" id="ws-space"></div></div>
    </button>

    <!-- RESULT CARD -->
    <section id="fortuneCard" class="fortune-card" aria-live="polite" aria-label="오늘의 문장">
      <div class="fc-left">
        <img id="fcCover" alt="Book cover" />
      </div>
      <div class="fc-right">
        <div id="fcText" class="fc-text"></div>
        <div class="fc-actions">
          <a id="fcOpen" class="btn open" target="_blank" rel="noopener">Open book</a>
          <button id="fcCopy" class="btn copy">Copy</button>
        </div>
        <div class="fc-meta">
          <div id="fcBook" class="fc-title"></div>
          <div class="fc-by"> <span id="fcAuthor"></span></div>
          <div class="fc-isbn">ISBN <span id="fcIsbn"></span></div>
          <a id="fcLink" class="fc-link" href="#" target="_blank" rel="noopener">View book</a>
        </div>
      </div>
    </section>
  </div>
</main>

<div id="again" class="again">Already revealed. Come back tomorrow ✨</div>

<script defer>
(function(){
  /* ---- your deployed Apps Script Web App URL ---- */
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwKejO7i3dEV3WB2KHUP1QKKJeX2bSzIGS4jZCxfeLJKwOGZEAMECXENvPH3IdT720OIw/exec';

  /* ---- utils ---- */
  const params = new URLSearchParams(location.search);
  const SRC = params.get('utm_source') || 'web';

  function todayKST() {
    const k = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    const y = k.getFullYear(), m = String(k.getMonth()+1).padStart(2,'0'), d = String(k.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  const UID_KEY = 'fortune-uid';
  function getUid(){
    let u = localStorage.getItem(UID_KEY);
    if(!u){ u = (crypto.randomUUID?.() || `${Date.now()}-${Math.random()}`); localStorage.setItem(UID_KEY, u); }
    return u;
  }

  /* ---- API helpers ---- */
  async function fetchQuote(ymd){
    const url = `${GAS_ENDPOINT}?d=${encodeURIComponent(ymd)}`;
    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok) throw new Error('network');
    return r.json(); // expect { ok:true, text, book, author, isbn, link, cover }
  }

  function logEvent(kind, ymd, note=''){
    const uid = getUid();
    const ua  = navigator.userAgent;
    fetch(`${GAS_ENDPOINT}?action=log&d=${encodeURIComponent(ymd)}&src=${encodeURIComponent(SRC)}&uid=${encodeURIComponent(uid)}&ua=${encodeURIComponent(ua)}&event=${encodeURIComponent(kind)}&note=${encodeURIComponent(note)}`)
      .catch(()=>{});
  }

  /* ---- DOM refs ---- */
  const globe     = document.getElementById('globe');
  const again     = document.getElementById('again');

  const card      = document.getElementById('fortuneCard');
  const fcCover   = document.getElementById('fcCover');
  const fcText    = document.getElementById('fcText');
  const fcCopy    = document.getElementById('fcCopy');
  const fcOpen    = document.getElementById('fcOpen');
  const fcBook    = document.getElementById('fcBook');
  const fcAuthor  = document.getElementById('fcAuthor');
  const fcIsbn    = document.getElementById('fcIsbn');
  const fcLink    = document.getElementById('fcLink');

  const ymd = todayKST();
  logEvent('view', ymd);

  function renderFortune(d){
    // cover
    if (d.cover) {
      fcCover.src = d.cover;
      fcCover.style.display = '';
    } else {
      fcCover.removeAttribute('src');
      fcCover.style.display = 'none';
    }

    // text
    fcText.textContent = d.text || '오늘 문장이 아직 없어요. 잠시 후 다시 시도해 주세요.';

    // metadata
    fcBook.textContent   = d.book   || '';
    fcAuthor.textContent = d.author || '';
    fcIsbn.textContent   = d.isbn   || '';

    // links
    if (d.link) {
      fcLink.href = d.link;
      fcLink.style.display = 'inline-block';
      fcOpen.href = d.link;
      fcOpen.style.display = 'inline-block';
    } else {
      fcLink.style.display = 'none';
      fcOpen.style.display = 'none';
    }

    // copy
    const copyText = d.text
      ? `${d.text}\n— ${[d.book, d.author].filter(Boolean).join(' • ')}${d.isbn ? ' • ISBN ' + d.isbn : ''}`.trim()
      : '';
    fcCopy.onclick = async () => {
      try { await navigator.clipboard.writeText(copyText); fcCopy.textContent='Copied!'; }
      catch { fcCopy.textContent='Copy failed'; }
      setTimeout(()=> fcCopy.textContent='Copy', 1200);
      logEvent('copy', ymd);
    };

    card.classList.add('show');
  }

  let opened = false;
  globe.addEventListener('click', async () => {
    if (opened) return;
    opened = true;
    logEvent('reveal', ymd);

    try {
      const j = await fetchQuote(ymd);
      if (j && j.ok) renderFortune(j);
      else renderFortune({});
    } catch {
      renderFortune({ text:"네트워크 오류입니다. 잠시 후 다시 시도해 주세요." });
    }

    setTimeout(()=> { again.style.display='block'; }, 80);
  });

  /* ===== word sphere (auto-rotate only) ===== */
  (function(){
    const WORDS = [
      "행복","사랑","지혜","용기","희망","성공","건강","평화","인내","감사","기쁨","성장","배움","도전","발견","기회",
      "신뢰","조화","창의","꿈","행운","번영","성실","책임","자유","진실","친절","공감","배려","균형","집중","열정",
      "여유","여행","자연","책","음악","예술","언어","문화","미래","오늘","미소","선물","빛","별","바람","바다","산",
      "길","시작","연결","협력","지식","호기심","격려","성찰","용서","성취","정직","따뜻함","지속","새로움"
    ];
    const host  = document.getElementById('word-sphere');
    const space = document.getElementById('ws-space');

    function fibonacciPoints(n){
      const pts=[], phi=(1+Math.sqrt(5))/2, ga=2-phi;
      for(let i=0;i<n;i++){
        const t=(i+.5)/n, y=1-2*t, r=Math.sqrt(1-y*y);
        const th=2*Math.PI*((i*ga)%1);
        pts.push([Math.cos(th)*r, y, Math.sin(th)*r]);
      }
      return pts;
    }

    const points = fibonacciPoints(WORDS.length);
    const nodes  = points.map((_,i)=>{
      const el = document.createElement('div');
      el.className = 'ws-word' + (Math.random()<0.12 ? ' ws-accent':'' );
      el.textContent = WORDS[i % WORDS.length];
      space.appendChild(el);
      return el;
    });

    const MINF=12, MAXF=28;
    const AUTO = { x: 0.0020, y: 0.0030 };
    let rx=0, ry=0;

    function radius(){
      const s = Math.min(host.clientWidth, host.clientHeight);
      return s * 0.44;
    }

    function render(){
      rx += AUTO.x; ry += AUTO.y;

      const sx=Math.sin(rx), cx=Math.cos(rx);
      const sy=Math.sin(ry), cy=Math.cos(ry);
      const R = radius();

      for(let i=0;i<points.length;i++){
        let [x,y,z] = points[i];

        let y1 = y*cx - z*sx;
        let z1 = y*sx + z*cx;
        let x2 =  x*cy + z1*sy;
        let z2 = -x*sy + z1*cy;

        const depth = (z2 + 1)/2;
        const font  = MINF + (MAXF - MINF) * (0.35 + 0.65*(1-depth));
        const tx = x2 * R, ty = y1 * R;

        const n = nodes[i];
        n.style.opacity = (0.45 + 0.55*(1-depth)).toFixed(3);
        n.style.filter  = `blur(${(0.35*depth).toFixed(2)}px)`;
        n.style.fontSize= font.toFixed(0)+'px';
        n.style.transform = `translate3d(calc(-50% + ${tx}px), calc(-50% + ${ty}px), ${ (z2*R).toFixed(1) }px)`;
      }
      requestAnimationFrame(render);
    }
    render();
    new ResizeObserver(()=>{}).observe(host);
  })();
})();
</script>
</body>
</html>
